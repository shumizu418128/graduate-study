graph TB
    subgraph "OSRM処理"
        A[リクエスト]
        A --> B[ルーティング計算<br/>最短/最速探索]
        B --> C[時間・距離集計]
        B --> D[経路形状生成]
        C --> E[レスポンス<br/>計算結果返却]
        D --> E
    end

    subgraph "メインワークフロー"
        F[建物ポイント読込<br/>避難所ポイント読込]

        F --> G[集約API]

        G --> H[近傍避難所検索<br/>上位3件]

        H --> I[各建物-避難所ペア処理]

        I --> J[OSRM Table API<br/>最寄避難所特定]
        J --> K[OSRM Route API<br/>経路ジオメトリ取得]

        K --> L[結果保存]
        L --> M[集約ポイント作成]
        L --> N[ルートライン作成]

        M --> O[ArcGIS<br/>Geodatabase]
        N --> O
    end

    subgraph "集約処理"
        P[リクエスト] --> Q[空間インデックス構築<br/>グリッドベース]
        Q --> R[グループ化処理<br/>半径内の点を集約]
        R --> S[凸包計算<br/>重心算出]
        S --> T[レスポンス<br/>集約結果返却]
    end

    J -.->|API呼び出し| A
    K -.->|API呼び出し| A
    G -.->|API呼び出し| P
